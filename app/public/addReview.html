<html>
  <head>
    <title>Submit Review</title>
    <style>
      #claimOwner {
        float: right;
        /* Other styles you might want to apply */
      }
      #editDescriptionButton {
        float: right;
        /* Other styles you might want to apply */
      }
      #coffeeShopDescription {
        border: 1px solid pink; /* You can adjust the border style, width, and color */
        padding: 10px; /* Optional: Add padding for better appearance */
      }
      .description-container {
        text-align: center; /* Center aligns the block elements */
      }
      .description-container h4 {
        text-align: center; /* Center aligns the h4 element */
      }
    </style>
  </head>
  <script>
    let values;
    let imageString;
    function generateHeader() {
      const search_string = location.search;

      decodedSearchString = decodeURI(search_string);

      //const queryString = search_string.startsWith("?") ? search_string.slice(1) : search_string;
      const queryString = decodedSearchString.startsWith("?")
        ? decodedSearchString.slice(1)
        : decodedSearchString;

      // Split the string into individual parameters
      const parameters = queryString.split("&");

      // Create an object to store the key-value pairs
      const paramsObject = {};

      // Split each parameter into its key and value
      parameters.forEach((param) => {
        const [key, value] = param.split("=");
        paramsObject[key] = value;
      });

      // Now, you have an object with the key-value pairs
      console.log(paramsObject);

      if ("name" in paramsObject) {
        // Use string interpolation to create the desired string
        const reviewString = `Review For ${paramsObject.name}`;
        document.getElementById("reviewTarget").textContent = reviewString;
      } else {
        console.log('The "name" key does not exist in the object.');
      }
      values = paramsObject;
    }
    function encodeImage() {
      const input = document.getElementById("image");
      const file = input.files[0];

      if (file) {
        const reader = new FileReader();
        reader.onloadend = function () {
          imageString = reader.result.split(",")[1];
        };
        reader.readAsDataURL(file);
      }
    }
  </script>

  <body>
    <div>
      <h1 id="reviewTarget">Review for</h1>
    </div>
    <script>
      generateHeader();
    </script>
    <div>
      <form id="theForm">
        <div class="description-container">
          <h4>Description</h4>
          <blockquote id="coffeeShopDescription" contenteditable="false">
            <p>
              Indulge in the rich, aromatic experience of our meticulously
              crafted coffee, delivering unparalleled taste and a delightful
              kick to your day!
            </p>
          </blockquote>
        </div>

        <button id="editDescriptionButton">Edit Description</button>

        <div>
          <label>How much will you rate this coffee shop?</label><br />
          <select id="ratings" name="ratings">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option></select
          ><br />
        </div>

        <label>Comments:</label><br />
        <input type="text" id="comments" />
        <button id="claimOwner">Claims This Business</button>

        <br /><br />
        <label>Upload Image:</label><br />
        <input
          type="file"
          id="image"
          accept="image/*"
          onchange="encodeImage()"
        />
      </form>
      <button id="Submit">Submit Review</button>
    </div>

    <script>
      let ratingsNum = document.getElementById("ratings");
      let comments = document.getElementById("comments");

      let button = document.getElementById("Submit");

      let claimBusinessButton = document.getElementById("claimOwner");
      let editDescriptionButton = document.getElementById(
        "editDescriptionButton"
      );

      // Function to fetch the coffee shop description and check permission to edit
      async function fetchCoffeeShopDescription() {
        try {
          const urlParams = new URLSearchParams(window.location.search);
          const storeName = urlParams.get("name");
          console.log("STORENAME", storeName);
          const storeLocation = urlParams.get("location");
          const response = await fetch(
            `/coffeeShopDescription?name=${storeName}&location=${storeLocation}`,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                // Include any necessary authentication tokens or headers
              },
            }
          );

          if (!response.ok) {
            //throw new Error("Unable to fetch data!!!!");
            const errorText = await response.text(); // Get the error text from the response
            throw new Error(
              `Failed with status ${response.status}: ${errorText}`
            );
          }

          const data = await response.json();

          if (data.canEdit) {
            // User has permission to edit the description
            // Show the edit description button or perform other actions
            const editDescriptionButton = document.getElementById(
              "editDescriptionButton"
            );
            const coffeeShopDescription = document.getElementById(
              "coffeeShopDescription"
            );

            editDescriptionButton.style.display = "block"; // Display the button
            editDescriptionButton.addEventListener("click", async (event) => {
              event.preventDefault();
              // Add your logic to handle the edit description functionality
              // This logic should be triggered when the user clicks the edit button
              coffeeShopDescription.contentEditable = "true";
            });
          } else {
            // User does not have permission to edit the description
            const editDescriptionButton = document.getElementById(
              "editDescriptionButton"
            );

            editDescriptionButton.style.display = "none";
            //alert(data.message); // Display an alert or handle accordingly
          }
        } catch (error) {
          console.error("Error:", error);
          // Handle errors or display an error message to the user
        }
      }

      // Call the function to fetch the coffee shop description and check permission
      fetchCoffeeShopDescription();
      // editDescriptionButton.addEventListener("click", async () => {
      //   event.preventDefault();
      // });

      // Assume this function is triggered when the review page for a shop is loaded
      function checkOwnerAndHideButton() {
        const urlParams = new URLSearchParams(window.location.search);
        const storeName = urlParams.get("name");
        console.log("checkOwnerIdfunction:!! ", storeName);
        const storeLocation = urlParams.get("location");

        fetch("/checkOwnerId", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            store: {
              name: storeName,
              location: storeLocation,
            },
          }),
        })
          .then((response) => {
            if (response.ok) {
              return response.json();
            } else {
              throw new Error("Failed to fetch owner ID.");
            }
          })
          .then((data) => {
            console.log("DATA", data);
            const ownerId = data.owner_id; // Assuming the response contains the owner_id
            console.log("OWNERID!!#@", ownerId);
            // If ownerId exists, hide the button
            // Hide Claim Business button if ownerId exists
            const claimBusinessButton = document.getElementById("claimOwner");
            if (ownerId && claimBusinessButton) {
              claimBusinessButton.style.display = "none";
            }
          })
          .catch((error) => {
            console.error("Error occurred:", error);
          });
      }

      // Call the function when the review page is loaded
      checkOwnerAndHideButton();

      claimBusinessButton.addEventListener("click", async () => {
        event.preventDefault();
        claimBusinessButton.style.display = "none";
        try {
          // Assuming you have a function to retrieve the user ID from the server-side
          //const userId = await getUserIdFromServer(); // Function to get user ID from the server

          // Send a POST request to claim ownership
          const urlParams = new URLSearchParams(window.location.search);
          const storeName = urlParams.get("name");
          const storeLocation = urlParams.get("location");

          const response = await fetch("/claimOwner", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              store: {
                name: storeName,
                location: storeLocation,
              },
            }),
          });

          if (response.ok) {
            console.log("User claimed ownership successfully.");
            fetchCoffeeShopDescription();
            // Optionally, update UI or perform additional actions upon success
          } else {
            console.error("Failed to claim ownership.");
            // Handle the case where claiming ownership fails
          }
        } catch (error) {
          console.error("Error occurred:", error);
        }
      });

      button.addEventListener("click", async () => {
        ratingsVal = ratingsNum.options[ratingsNum.selectedIndex].text;
        commentsVal = comments.value;
        storeVals = values;
        console.log("Image string" + imageString);

        await fetch("/map/submitReview", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            ratings: ratingsVal,
            comments: commentsVal,
            store: storeVals,
            image: imageString,
          }),
        });
        var form = document.getElementById("theForm");
        form.reset();

        //TO DO - get this to return back to the map page with the review feed that's holding the reviews for the shop I just submitted a review for
        window.location.href = "http://localhost:3000/map";
      });
    </script>
  </body>
</html>
