<html>
  <head>
    <title>Find Me Coffee</title>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-assembly/v1.3.0/assembly.min.css"
      rel="stylesheet"
    />
    <script
      id="search-js"
      defer=""
      src="https://api.mapbox.com/search-js/v1.0.0-beta.17/web.js"
    ></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
      .marker-label {
        position: absolute;
        top: 100px;

        background-color: transparent;
        border: none;
        padding: 5px;
        font-size: 15px;
        font-family: "Open Sans", sans-serif;
        font-weight: 600;
        text-align: center;
        pointer-events: none;
      }

      /* CSS for the submit review button https://getcssscan.com/css-buttons-examples*/
      .button-1 {
        background-color: #EA4C89;
        border-radius: 8px;
        border-style: none;
        box-sizing: border-box;
        color: #FFFFFF;
        cursor: pointer;
        display: none;
        /* font-family: "Haas Grot Text R Web", "Helvetica Neue", Helvetica, Arial, sans-serif; */
        font-size: 16px;
        font-weight: 500;
        height: 40px;
        line-height: 20px;
        list-style: none;
        margin: 0;
        outline: none;
        padding: 10px 16px;
        position: relative;
        text-align: center;
        text-decoration: none;
        transition: color 100ms;
        vertical-align: baseline;
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
      }

      .button-1:hover,
      .button-1:focus {
        background-color: #F082AC;
      }

      .half-space-above {
        margin-top: 0.8em; 
      }

    </style>
    <!-- Scripts Loaded Prior to Page -->
    <!-- <script src="defaultCoffeeShops.js"></script> -->
    <script src="sidebar.js"></script>
  </head>
  <body>
    <div
      id="navbar"
      style="
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 0.8%;
      "
    >
      <h2 style="margin: 0">
        Find Me Coffee
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="32"
          height="32"
          fill="currentColor"
          class="bi bi-cup"
          viewBox="0 0 16 16"
        >
          <path
            fill-rule="evenodd"
            d="M.11 3.187A.5.5 0 0 1 .5 3h13a.5.5 0 0 1 .488.608l-.22.991a3.001 3.001 0 0 1-1.3 5.854l-.132.59A2.5 2.5 0 0 1 9.896 13H4.104a2.5 2.5 0 0 1-2.44-1.958L.012 3.608a.5.5 0 0 1 .098-.42Zm12.574 6.288a2 2 0 0 0 .866-3.899l-.866 3.9ZM1.124 4l1.516 6.825A1.5 1.5 0 0 0 4.104 12h5.792a1.5 1.5 0 0 0 1.464-1.175L12.877 4H1.123Z"
          />
        </svg>
      </h2>
      <a href="http://localhost:3000/logout" role="button" class="btn btn-info"
        >Logout</a
      >
    </div>
    <div
      id="sidebar"
      style="
        width: 25%;
        margin-left: auto;
        margin-right: 0;
        max-height: 89vh;
        overflow-y: auto;
      "
    >
      <h3 id="sidebar_title" class="text-center">Review Feed</h3>
      <div id="test" style="text-align: center;">
        <span class="half-space-above"></span>
        <button class="button-1" id="submitShopReviewButton">Submit A Review</button> 
      </div>
      <div id="sidebar_body">
      </div>
    </div>
    <!-- Sidebar Card To Render -->
    <template id="reviewCardTemplate">
      <div class="card m-4 mr-4" style="max-width: 100%">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title" id="cardUsername"></h5>
            <small class="text-muted" id="cardDate"></small>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="card-subtitle mb-2" id="cardShopName"></h6>
            <small class="text-muted" id="cardRating"></small>
          </div>
          <p class="card-text" id="cardComments"></p>
        </div>
      </div>
    </template>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
      crossorigin="anonymous"
    ></script>
  </body>
  <div id="map" style="width: 75%; height: 90vh; margin-top: 10vh"></div>

  <script src="searchForOne.js"></script>

  <script>
    //joes const ACCESS_TOKEN = "pk.eyJ1Ijoiam00NjQ2IiwiYSI6ImNsbzRqdHkwYjAyankya251M3BxYTc0bTYifQ.DPfLWp7phIy4Yx2fAnUARg";
    //erin:
    const ACCESS_TOKEN = "pk.eyJ1IjoiZXJpbm1jZ2xldyIsImEiOiJjbG80a3E1NjEwMmg1MmpzMHRwcGtzNDZkIn0.d_LYyduEKt8jnwP4gCmByQ";
    console.log(ACCESS_TOKEN);
    mapboxgl.accessToken = ACCESS_TOKEN;

    //loads the map
    const map = new mapboxgl.Map({
      container: "map", // container ID
      style: "mapbox://styles/mapbox/streets-v12", // style URL
      center: [-74.5, 40], // starting position [lng, lat]
      zoom: 9, // starting zoom
    });

    // Add zoom and rotation controls to the map.
    map.addControl(new mapboxgl.NavigationControl());

    // Initialize the GeolocateControl.
    const geolocate = new mapboxgl.GeolocateControl({
      positionOptions: {
        enableHighAccuracy: true,
      },
      trackUserLocation: true,
    });

    // Add geolocate control to the map
    map.addControl(geolocate);

    let position = [];
    let latitude = 0;
    let longitude = 0;

    // Function to wait for geolocation event
    function waitForGeolocation() {
      return new Promise(function (resolve, reject) {
        geolocate.on("geolocate", function (event) {
          var latitude = event.coords.latitude;
          var longitude = event.coords.longitude;
          resolve({ latitude, longitude });
        });
      });
    }

    const searchJS = document.getElementById("search-js");
    searchJS.onload = function () {
      const searchBox = new MapboxSearchBox();
      searchBox.accessToken = ACCESS_TOKEN;
      searchBox.options = {
        types: "address, poi, category",
        proximity: [latitude, longitude],
        bbox: [
          [-75.25706, 39.89377],
          [-75.00475, 40.11012],
        ],
        limit: 10,
        poi_category: "coffee",
        //poi_category_exclusions: "burger",
        // poi_category_exclusions:
        //   "restaurant,food,food_and_drink,burger_restaurant,fast_food restaurant",
      };
      searchBox.mapboxgl = mapboxgl;
      map.addControl(searchBox, "top-left");

      //searchForOne();

      let markers_array = [];
      labels = [];
      searchBox.addEventListener("retrieve", function (result) {
        console.log("RETRIEVE!!!!", result.detail);
        searchBox.marker = false;
        //removeCustomMarkerFromOneSearch(); //from searchForOne() function

        //clear existing markers
        //need a another forEach to clear the default markers
        markers_array.forEach((marker) => marker.remove());
        // default_markers_array.forEach((marker) => marker.remove());
        markers = [];

        //clear existing labels
        labels.forEach((label) => {
          if (label.parentNode) {
            label.parentNode.removeChild(label); // Remove label from the map container
          }
        });

        const features = result.detail.features;
        features.forEach((feature) => {
          console.log("hi");
          console.log(feature);
          const coordinates = feature.geometry.coordinates;
          // Create a new custom marker element for each marker instance
          let customMarker = document.createElement("img");
          customMarker.className = "custom-marker"; // Apply any custom styling using CSS
          customMarker.src =
            "https://docs.mapbox.com/mapbox-gl-js/assets/custom_marker.png";
          const marker = new mapboxgl.Marker({
            color: "#FFC0CB",
            element: customMarker,
          })
            .setLngLat(coordinates)
            .addTo(map);

          // Create a new HTML element for the marker label
          const label = document.createElement("div");
          label.className = "marker-label";
          label.textContent = feature.properties.name;

          //      ----------WIP-----
          // if (feature.properties.name == feature.properties.address) {
          //   label.textContent = feature.properties.name;
          // } else {
          //   label.textContent = feature.properties.name;
          // }

          // Append the label to the map container
          map.getCanvasContainer().appendChild(label);
          labels.push(label);

          // Function to update label position based on marker position
          function updateLabelPosition() {
            const markerPos = marker.getLngLat();
            const labelPos = map.project(markerPos);
            //console.log("nanny",labelPos);

            // Set label position offset (adjust as needed)
            label.style.left = labelPos.x - 30 + "px";
            label.style.top = labelPos.y + 15 + "px"; // Adjust vertical offset as needed
          }

          // Initial update of label position
          updateLabelPosition();

          // Update label position when the map is moved or zoomed
          map.on("move", updateLabelPosition);

          let description = feature.properties.full_address;
          let title = feature.properties.name;
          const coordinate = features[0].geometry.coordinates;
          let location = coordinate[0] + "," + coordinate[1];

          marker.getElement().addEventListener("click", function () {
            const sidebarBody = document.getElementById('sidebar_body');
            //deleting sidebar children (the latest reviews)
            //https://www.w3schools.com/jsref/met_node_removechild.asp
            while (sidebarBody.hasChildNodes()) {
                sidebarBody.removeChild(sidebarBody.firstChild);
            }
            loadShopReviews(title, location);
          });

          // Use Mapbox Geocoding API to convert address to coordinates
          // const mapboxGeocodingUrl = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(
          //   description
          // )}.json?access_token=${ACCESS_TOKEN}`;

          // fetch(mapboxGeocodingUrl)
          //   .then((response) => response.json())
          //   .then((data) => {
          //     console.log("DATA!!! ", data);
          //     const coordinates = data.features[0].geometry.coordinates;
          //     // Use coordinates to place a marker or navigate to that location on the map
          //     // Example: map.setCenter(coordinates);
          //     // Example: addMarker(coordinates);
          //   })
          //   .catch((error) => {
          //     console.error("Error:", error);
          //   });
        });
      });
    };

    map.on("load", function () {
      geolocate.trigger();
    });

    // Onload Create the feed
    loadFeed();
    // showReviews();
  </script>
  
  <script src="defaultCoffeeShops.js"></script>
  <!-- <script>loadShopReviews();</script> -->
</html>
