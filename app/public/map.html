<html>
  <head>
    <title>Find Me Coffee</title>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-assembly/v1.3.0/assembly.min.css"
      rel="stylesheet"
    />
    <script
      id="search-js"
      defer=""
      src="https://api.mapbox.com/search-js/v1.0.0-beta.17/web.js"
    ></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="navbar" style="display: flex; align-items: center; justify-content: space-between; margin: 0.8%">
      <h2 style="margin: 0;">Find Me Coffee
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-cup" viewBox="0 0 16 16">
          <path fill-rule="evenodd" d="M.11 3.187A.5.5 0 0 1 .5 3h13a.5.5 0 0 1 .488.608l-.22.991a3.001 3.001 0 0 1-1.3 5.854l-.132.59A2.5 2.5 0 0 1 9.896 13H4.104a2.5 2.5 0 0 1-2.44-1.958L.012 3.608a.5.5 0 0 1 .098-.42Zm12.574 6.288a2 2 0 0 0 .866-3.899l-.866 3.9ZM1.124 4l1.516 6.825A1.5 1.5 0 0 0 4.104 12h5.792a1.5 1.5 0 0 0 1.464-1.175L12.877 4H1.123Z"/>
        </svg>
      </h2>
      <a href="http://localhost:3000/logout" role="button" class="btn btn-info">Logout</a>
    </div> 
    <div id="sidebar" style="width: 25%; margin-left: auto; margin-right: 0;">
      <h3 id="sidebar_title" class="text-center">Review Feed</h3>
      <div id="sidebar_body">
        <div class="text-center">Review</div>
        <div class="text-center">Review</div>
        <div class="text-center">Review</div>
        <div class="text-center">Review</div>
        <div class="text-center">Review</div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
  </body>
  <div id="map" style="width: 75%; height: 90vh; margin-top: 10vh;"></div>
  <script>
    const ACCESS_TOKEN =
      "pk.eyJ1Ijoiam00NjQ2IiwiYSI6ImNsbzRqdHkwYjAyankya251M3BxYTc0bTYifQ.DPfLWp7phIy4Yx2fAnUARg";
    console.log(ACCESS_TOKEN);
    mapboxgl.accessToken = ACCESS_TOKEN;

    //loads the map
    const map = new mapboxgl.Map({
      container: "map", // container ID
      style: "mapbox://styles/mapbox/streets-v12", // style URL
      center: [-74.5, 40], // starting position [lng, lat]
      zoom: 9, // starting zoom
    });

    // Add zoom and rotation controls to the map.
    map.addControl(new mapboxgl.NavigationControl());

    // Initialize the GeolocateControl.
    const geolocate = new mapboxgl.GeolocateControl({
      positionOptions: {
        enableHighAccuracy: true,
      },
      trackUserLocation: true,
    });

    // Add geolocate control to the map
    map.addControl(geolocate);

    let position = [];
    let latitude = 0;
    let longitude = 0;

    // Function to wait for geolocation event
    function waitForGeolocation() {
      return new Promise(function (resolve, reject) {
        geolocate.on("geolocate", function (event) {
          var latitude = event.coords.latitude;
          var longitude = event.coords.longitude;
          resolve({ latitude, longitude });
        });
      });
    }

    const searchJS = document.getElementById("search-js");
    searchJS.onload = function () {
      const searchBox = new MapboxSearchBox();
      searchBox.accessToken = ACCESS_TOKEN;
      searchBox.options = {
        types: "address, poi, category",
        proximity: [latitude, longitude],
        bbox: [
          [-75.25706, 39.89377],
          [-75.00475, 40.11012],
        ],
        limit: 9,
        poi_category: "coffee",
        //poi_category_exclusions: "burger",
        // poi_category_exclusions:
        //   "restaurant,food,food_and_drink,burger_restaurant,fast_food restaurant",
      };
      searchBox.marker = true;
      searchBox.mapboxgl = mapboxgl;
      map.addControl(searchBox, "top-left");

      let markers_array = [];
      searchBox.addEventListener("retrieve", function (result) {
        console.log(result.detail);
        //for (let foo of result.detail.features) {
        //console.log("hello");
        //console.log(foo);
        //}
        //clear existing markers
        markers_array.forEach((marker) => marker.remove());
        // default_markers_array.forEach((marker) => marker.remove());
        markers = [];

        const features = result.detail.features;
        features.forEach((feature) => {
          console.log("hi");
          console.log(feature);
          const coordinates = feature.geometry.coordinates;
          const marker = new mapboxgl.Marker()
            .setLngLat(coordinates)
            .addTo(map);

          // Optionally, you can add a popup to each marker
          const popup = new mapboxgl.Popup().setHTML("hi");
          //const popup = new mapboxgl.Popup().setHTML(feature.properties.name);
          marker.setPopup(popup);
          markers_array.push(marker);
          //markers_array[0].togglePopup();
          // setTimeout(() => {
          //   markers_array[0].togglePopup();
          // }, 500);
          function toggleFirstMarkerPopup() {
            const firstMarker = markers_array[0];

            // Check if the first marker has a popup
            if (firstMarker.getPopup()) {
              if (firstMarker.getPopup().isOpen()) {
                // If popup is open, close it
                firstMarker.getPopup().remove();
              } else {
                // If popup is closed, open it
                firstMarker.togglePopup();
              }
            }
          }

          // // Add an event listener to the map to handle clicks on the first marker
          map.on("click", () => {
            toggleFirstMarkerPopup();
          });
        });
      });
    };

    map.on("load", function () {
      geolocate.trigger();
    });
  </script>
  <script src="defaultCoffeeShops.js"></script>
</html>
