<html>
  <head>
    <title>Find Me Coffee</title>

    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-assembly/v1.3.0/assembly.min.css"
      rel="stylesheet"
    />
    <script
      id="search-js"
      defer=""
      src="https://api.mapbox.com/search-js/v1.0.0-beta.17/web.js"
    ></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
    </style>
  </head>
  <body>
    Find me coffee app. Render mapbox HTML map here.
  </body>
  <div id="map"></div>
  <script>
    const ACCESS_TOKEN =
      "pk.eyJ1Ijoiam00NjQ2IiwiYSI6ImNsbzRqdHkwYjAyankya251M3BxYTc0bTYifQ.DPfLWp7phIy4Yx2fAnUARg";
    console.log(ACCESS_TOKEN);
    mapboxgl.accessToken = ACCESS_TOKEN;

    //loads the map
    const map = new mapboxgl.Map({
      container: "map", // container ID
      style: "mapbox://styles/mapbox/streets-v12", // style URL
      center: [-74.5, 40], // starting position [lng, lat]
      zoom: 9, // starting zoom
    });

    // Add zoom and rotation controls to the map.
    map.addControl(new mapboxgl.NavigationControl());

    // Initialize the GeolocateControl.
    const geolocate = new mapboxgl.GeolocateControl({
      positionOptions: {
        enableHighAccuracy: true,
      },
      trackUserLocation: true,
    });

    // Add geolocate control to the map
    map.addControl(geolocate);

    let position = [];
    let latitude = 0;
    let longitude = 0;

    // Function to wait for geolocation event
    function waitForGeolocation() {
      return new Promise(function (resolve, reject) {
        geolocate.on("geolocate", function (event) {
          var latitude = event.coords.latitude;
          var longitude = event.coords.longitude;
          resolve({ latitude, longitude });
        });
      });
    }

    const searchJS = document.getElementById("search-js");
    searchJS.onload = function () {
      const searchBox = new MapboxSearchBox();
      searchBox.accessToken = ACCESS_TOKEN;
      searchBox.options = {
        types: "address, poi, category",
        proximity: [latitude, longitude],
        bbox: [
          [-75.25706, 39.89377],
          [-75.00475, 40.11012],
        ],
        limit: 9,
        poi_category: "coffee",
        //poi_category_exclusions: "burger",
        // poi_category_exclusions:
        //   "restaurant,food,food_and_drink,burger_restaurant,fast_food restaurant",
      };
      searchBox.marker = true;
      searchBox.mapboxgl = mapboxgl;
      map.addControl(searchBox, "top-left");

      let markers_array = [];
      searchBox.addEventListener("retrieve", function (result) {
        console.log(result.detail);
        //for (let foo of result.detail.features) {
        //console.log("hello");
        //console.log(foo);
        //}
        //clear existing markers
        markers_array.forEach((marker) => marker.remove());
        markers = [];

        const features = result.detail.features;
        features.forEach((feature) => {
          console.log("hi");
          console.log(feature);
          const coordinates = feature.geometry.coordinates;
          const marker = new mapboxgl.Marker()
            .setLngLat(coordinates)
            .addTo(map);
          markers_array.push(marker);

          // Optionally, you can add a popup to each marker
          const popup = new mapboxgl.Popup().setHTML(feature.properties.name);
          marker.setPopup(popup);
          marker.togglePopup();
        });
      });
    };

    map.on("load", function () {
      geolocate.trigger();
    });
  </script>
  <script src="defaultCoffeeShops.js"></script>
</html>
